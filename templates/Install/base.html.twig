<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>{% block title %}Install{% endblock %}</title>
        {% block stylesheets %}{% endblock %}
        {% block javascripts %}
            {% block importmap %}{{ importmap('installer') }}{% endblock %}
            <script>
                const formFields = ['form_siteName', 'form_siteUrl', 'form_email', 'form_username', 'form_plainPassword_first', 'form_plainPassword_second'];
                let currentStep = 1;

                function showStep(step) {
                    document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
                    document.getElementById(`step-${step}`).classList.add('active');
                    currentStep = step;
                }

                function prevStep() {
                    showStep(currentStep - 1);
                }

                function validateStep(step) {
                    let valid = true;
                    const stepEl = document.getElementById(`step-${step}`);
                    const inputs = stepEl.querySelectorAll('input');

                    inputs.forEach(input => {
                        input.classList.remove('is-invalid');
                        if (!input.checkValidity()) {
                            input.classList.add('is-invalid');
                            valid = false;
                        }
                    });

                    if (valid) showStep(step + 1);
                }

                document.getElementById('installerForm').addEventListener('submit', function (e) {
                    e.preventDefault();
                    let valid = true;
                    const inputs = document.querySelectorAll('#step-2 input');

                    inputs.forEach(input => {
                        input.classList.remove('is-invalid');
                        if (!input.checkValidity()) {
                            input.classList.add('is-invalid');
                            valid = false;
                        }
                    });

                    if (valid) {
                        alert('Installation complete!');
                        localStorage.clear(); // clear saved data
                    }
                });

                // Save input to localStorage
                formFields.forEach(id => {
                    const el = document.getElementById(id);
                    el.addEventListener('input', () => {
                        localStorage.setItem(id, el.value);
                    });
                });

                // Restore input from localStorage
                window.addEventListener('DOMContentLoaded', () => {
                    formFields.forEach(id => {
                        const saved = localStorage.getItem(id);
                        if (saved !== null) document.getElementById(id).value = saved;
                    });
                });
            </script>
        {% endblock %}
    </head>
    <body>

        {% if messages is defined and messages|length > 0 %}
            <div id="globalError" class="alert alert-{{ messages.level }} d-none" role="alert">
                {{ messages.message }}
            </div>
        {% endif %}

        <div class="install-box">
            <h2 class="text-center mb-4">Tech Portal Installer</h2>
            {% block steps %}
                {{ form_start(form, { 'attr': { 'id': 'installerForm', novalidate: 'novalidate' } }) }}
                    <!-- Step 1 -->
                    <div id="step-1" class="step active">
                        <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                            <symbol id="exclamation-triangle-fill" viewBox="0 0 16 16">
                                <path fill="currentColor" d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/>
                            </symbol>
                        </svg>
                        <div class="mb-3">
                            <p class="mb-3">
                                Welcome to the <strong>Tech Portal</strong> application installer. This application is designed
                                as an internal tool  to be used for the purpose of tracking work orders, assets and repairs.
                                This application was created in an K-12 education setting and might serve it's purpose better
                                in that work place.
                            </p>
                            <div class="alert alert-warning">
                                <svg class="bi flex-shrink-0 me-2" width="24" height="24" role="img" aria-label="Warning:"><use xlink:href="#exclamation-triangle-fill"/></svg>
                                <strong>WARNING:</strong> This application is a work in progress and might not contain all the
                                necessary security protocols required to operate over the internet. It is designed to be used
                                as an internal tool in a local network. If you choose to install this on a publicly accessible
                                machine, you do so at your own risk.
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" value="" id="agreeCheckBox" required>
                                <label for="agreeCheckBox" class="form-check-label">I Agree</label>
                            </div>
                        </div>
                        <div class="d-flex justify-content-end">
                            <button class="btn btn-primary" type="button" onclick="validateStep(1)">Next</button>
                        </div>
                    </div>

                    <!-- Step 2 -->
                    <div id="step-2" class="step">
                        <div class="mb-3 text-center">
                            <strong>Application Information</strong>
                        </div>
                        <div class="mb-3">
                            {{ form_row(form.siteName) }}
                            <div class="invalid-feedback">Please provide an application name.</div>
                        </div>
                        <div class="mb-3">
                            {{ form_row(form.siteUrl) }}
                            <div class="invalid-feedback">Please provide a valid URL.</div>
                        </div>
                        <div class="d-flex justify-content-between">
                            <button class="btn btn-secondary" type="button" onclick="prevStep()">Back</button>
                            <button class="btn btn-primary" type="button" onclick="validateStep(2)">Next</button>
                        </div>
                    </div>

                    <!-- Step 3 -->
                    <div id="step-3" class="step">
                        <div class="mb-3 text-center">
                            <strong>Admin Information</strong>
                        </div>
                        <div class="mb-3">
                            {{ form_row(form.username) }}
                            <div class="invalid-feedback">Enter a valid username.</div>
                        </div>
                        <div class="mb-3">
                            {{ form_row(form.email) }}
                            <div class="invalid-feedback">Enter a valid email address.</div>
                        </div>
                        <div class="mb-3">
                            <div class="row">
                                <div class="col">
                                    {{ form_row(form.plainPassword.first) }}
                                </div>
                                <div class="col">
                                    {{ form_row(form.plainPassword.second) }}
                                </div>
                                <div class="invalid-feedback">Password must be at least 6 characters.</div>
                            </div>
                        </div>
                        <div class="mb-3">
                            {{ form_row(form.firstName) }}
                        </div>
                        <div class="mb-3">
                            {{ form_row(form.lastName) }}
                        </div>
                        <div class="d-flex justify-content-between">
                            <button class="btn btn-secondary" type="button" onclick="prevStep()">Back</button>
                            <button class="btn btn-primary" type="button" onclick="validateStep(3)">Next</button>
{#                            <button class="btn btn-success" type="submit">Install</button>#}
{#                            {{ form_widget(form.install) }}#}
                        </div>
                    </div>
                    <div id="step-4" class="step">
                        <div class="mb-3">
                            further installation process
                        </div>
                        <div class="d-flex justify-content-between">
                            <button class="btn btn-secondary" type="button" onclick="prevStep()">Back</button>
                            {{ form_widget(form.install) }}
                        </div>
                    </div>
                {{ form_end(form) }}
            {% endblock %}
        </div>
    </body>
</html>
