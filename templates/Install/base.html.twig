<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>{% block title %}Install{% endblock %}</title>
        {% block stylesheets %}{% endblock %}
        {% block javascripts %}
            {% block importmap %}{{ importmap('installer') }}{% endblock %}
            <script>
                const formFields = ['appName', 'appUrl', 'adminEmail', 'adminPassword'];
                let currentStep = 1;

                function showStep(step) {
                    document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
                    document.getElementById(`step-${step}`).classList.add('active');
                    currentStep = step;
                }

                function prevStep() {
                    showStep(currentStep - 1);
                }

                function validateStep(step) {
                    let valid = true;
                    const stepEl = document.getElementById(`step-${step}`);
                    const inputs = stepEl.querySelectorAll('input');

                    inputs.forEach(input => {
                        input.classList.remove('is-invalid');
                        if (!input.checkValidity()) {
                            input.classList.add('is-invalid');
                            valid = false;
                        }
                    });

                    if (valid) showStep(step + 1);
                }

                document.getElementById('installerForm').addEventListener('submit', function (e) {
                    e.preventDefault();
                    let valid = true;
                    const inputs = document.querySelectorAll('#step-2 input');

                    inputs.forEach(input => {
                        input.classList.remove('is-invalid');
                        if (!input.checkValidity()) {
                            input.classList.add('is-invalid');
                            valid = false;
                        }
                    });

                    if (valid) {
                        alert('Installation complete!');
                        localStorage.clear(); // clear saved data
                    }
                });

                // Save input to localStorage
                formFields.forEach(id => {
                    const el = document.getElementById(id);
                    el.addEventListener('input', () => {
                        localStorage.setItem(id, el.value);
                    });
                });

                // Restore input from localStorage
                window.addEventListener('DOMContentLoaded', () => {
                    formFields.forEach(id => {
                        const saved = localStorage.getItem(id);
                        if (saved !== null) document.getElementById(id).value = saved;
                    });
                });
            </script>
        {% endblock %}
    </head>
    <body>

        {% if messages is defined and messages|length > 0 %}
            <div id="globalError" class="alert alert-{{ messages.level }} d-none" role="alert">
                {{ messages.message }}
            </div>
        {% endif %}

        <div class="install-box">
            <h2 class="text-center mb-4">App Installer</h2>
            {% block steps %}
                <form id="installerForm" novalidate>
                    <!-- Step 1 -->
                    <div id="step-1" class="step active">
                        <div class="mb-3">
                            <label for="appName" class="form-label">Application Name</label>
                            <input type="text" class="form-control" id="appName" required>
                            <div class="invalid-feedback">Please provide an application name.</div>
                        </div>
                        <div class="mb-3">
                            <label for="appUrl" class="form-label">Application URL</label>
                            <input type="url" class="form-control" id="appUrl" required>
                            <div class="invalid-feedback">Please provide a valid URL.</div>
                        </div>
                        <div class="d-flex justify-content-end">
                            <button class="btn btn-primary" type="button" onclick="validateStep(1)">Next</button>
                        </div>
                    </div>

                    <!-- Step 2 -->
                    <div id="step-2" class="step">
                        <div class="mb-3">
                            <label for="adminEmail" class="form-label">Admin Email</label>
                            <input type="email" class="form-control" id="adminEmail" required>
                            <div class="invalid-feedback">Enter a valid email address.</div>
                        </div>
                        <div class="mb-3">
                            <label for="adminPassword" class="form-label">Password</label>
                            <input type="password" class="form-control" id="adminPassword" required minlength="6">
                            <div class="invalid-feedback">Password must be at least 6 characters.</div>
                        </div>
                        <div class="d-flex justify-content-between">
                            <button class="btn btn-secondary" type="button" onclick="prevStep()">Back</button>
                            <button class="btn btn-success" type="submit">Install</button>
                        </div>
                    </div>
                </form>
            {% endblock %}
        </div>
    </body>
</html>
