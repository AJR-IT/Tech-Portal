<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>{% block title %}Install{% endblock %}</title>
        {% block stylesheets %}{% endblock %}
        {% block javascripts %}
            {% block importmap %}{{ importmap('installer') }}{% endblock %}
            <script>
                const formFields = [
                    'form_siteName',
                    'form_siteUrl',
                    'form_email',
                    'form_username',
                    'form_plainPassword_first',
                    'form_plainPassword_second'
                ];
                let currentStep = 1;

                function showStep(step) {
                    document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
                    document.getElementById(`step-${step}`).classList.add('active');
                    currentStep = step;
                }

                function prevStep() {
                    showStep(currentStep - 1);
                }

                function validateStep(step) {
                    let valid = true;
                    const stepEl = document.getElementById(`step-${step}`);
                    const inputs = stepEl.querySelectorAll('input');

                    inputs.forEach(input => {
                        input.classList.remove('is-invalid');
                        if (!input.checkValidity()) {
                            input.classList.add('is-invalid');
                            valid = false;
                        }
                    });

                    // Password match check for step 3
                    if (step === 3) {
                        const pw1 = document.getElementById('form_plainPassword_first');
                        const pw2 = document.getElementById('form_plainPassword_second');
                        if (pw1 && pw2 && pw1.value !== pw2.value) {
                            pw2.classList.add('is-invalid');
                            const feedback = pw2.nextElementSibling;
                            if (feedback) feedback.textContent = 'Passwords do not match.';
                            valid = false;
                        }
                    }

                    if (valid && step < 4) {
                        showStep(step + 1);
                    } else if (valid && step === 3) {
                        localStorage.clear(); // Clear saved form data on final step
                    }
                }

                document.addEventListener('DOMContentLoaded', () => {
                    // prevent Enter key from submitting the form prematurely
                    const form = document.getElementById('installerForm');
                    if (form) {
                        form.addEventListener('keydown', (e) => {
                            if (e.key === 'Enter') {
                                e.preventDefault();
                                validateStep(currentStep);
                            }
                        });
                    }

                    formFields.forEach(id => {
                        const el = document.getElementById(id);
                        if (el) {
                            // Restore from localStorage
                            const saved = localStorage.getItem(id);
                            if (saved !== null) el.value = saved;

                            // Save to localStorage
                            el.addEventListener('input', () => {
                                localStorage.setItem(id, el.value);
                            });
                        }
                    });
                });
            </script>
        {% endblock %}
    </head>
    <body>
        {% block error %}
            {% if messages is defined and messages|length > 0 %}
                <div id="globalError" class="alert alert-{{ messages.level }} d-none" role="alert">
                    {{ messages.message }}
                </div>
            {% endif %}
        {% endblock %}

        <div class="install-box">
            <h2 class="text-center mb-3">Tech Portal Installer</h2>
            {% block steps %}{% endblock %}
        </div>
    </body>
</html>
